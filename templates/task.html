{% extends "dashboard_magang.html" %} {% block title %}
<title>AbsensiKu | Tugas</title>
{% endblock %} {% block cdn_custom_css %}
<!-- datatables css link -->
<link
    href="https://cdn.datatables.net/v/bs5/jq-3.7.0/jszip-3.10.1/dt-2.1.8/af-2.7.0/b-3.1.2/b-colvis-3.1.2/b-html5-3.1.2/b-print-3.1.2/cr-2.0.4/date-1.5.4/fc-5.0.3/fh-4.0.1/kt-2.12.1/r-3.0.3/rg-1.5.0/rr-1.5.0/sc-2.4.3/sb-1.8.1/sp-2.3.3/sl-2.1.0/sr-1.4.1/datatables.min.css"
    rel="stylesheet" />

{% endblock %}

{% block custom_css %}
<!-- css custom -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
<style>
    td#Pending .card {
        cursor: grab;
        /* Menampilkan cursor grab saat elemen bisa di-drag */
        cursor: -moz-grab;
        cursor: -webkit-grab
    }

    td#Progress .card {
        cursor: grab;
        /* Menampilkan cursor grab saat elemen bisa di-drag */
        cursor: -moz-grab;
        cursor: -webkit-grab
    }

    .dragging {
        cursor: grabbing;
        /* Menampilkan cursor grabbing saat elemen sedang di-drag */
        cursor: -moz-grabbing;
        cursor: -webkit-grabbing;
    }

    .disabled-drag {
        cursor: not-allowed;
        /* Tunjukkan bahwa dragging dinonaktifkan */
        opacity: 0.6;
        /* Memberi efek "disable" */
    }
</style>
{% endblock custom_css %}

{% block navbar %}
<ul class="navbar-nav me-auto mb-2 mb-lg-0">
    {% if not (data.departement == 'Mentor' and data.jobs == 'Sub Admin') and data.role in (1,3) %}
    <li class="nav-item">
        <a class="nav-link poppins-regular text-pink d-flex align-items-center gap-2" href="/dashboard"><i
                class="fas fa-house-chimney fa-2xl text-primary w-100"
                style="font-size: 1em; max-width:20px"></i>Halaman Utama</a>
    </li>
    {% endif %}
    <li class="nav-item">
        <a class="nav-link poppins-regular text-pink d-flex align-items-center gap-2" href="/change-password">
            <i class="fas fa-key fa-2xl text-primary w-100" style="font-size: 1em; max-width:20px"></i>Ubah Password
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link poppins-regular text-pink d-flex align-items-center gap-2" href="/riwayat-kehadiran"><i
                class="fas fa-calendar-check fa-2xl text-primary w-100"
                style="font-size: 1em; max-width:20px"></i>Riwayat Kehadiran
            Karyawan</a>
    </li>
    {% if data.role==1 %}
    {% if data.departement=='Mentor' and data.jobs=='Admin' %}
    <li class="nav-item">
        <a class="nav-link poppins-regular text-pink  d-flex align-items-center gap-2" href="/riwayat-bantuan"><i
                class="fas fa-circle-question fa-2xl text-primary w-100" style="font-size: 1em; max-width:20px"></i>
            Riwayat Bantuan</a>
    </li>
    {% endif %}
    {% if data.departement == 'Superuser' %}
    <li class="nav-item">
        <a class="nav-link poppins-regular text-pink d-flex align-items-center gap-2" href="/kelola-admin"><i
                class="fas fa-user-tie fa-2xl text-primary w-100" style="font-size: 1em; max-width:20px"></i>Kelola
            Admin</a>
    </li>
    {% endif %}
    {% endif %}
    <li class="nav-item">
        <a class="nav-link poppins-regular text-pink d-flex align-items-center gap-2 active" href="/task"><i
                class="fa-regular fa-pen-to-square fa-2xl text-primary w-100"
                style="font-size: 1em; max-width:20px"></i>Tugas</a>
    </li>
</ul>
{% endblock %} {% block content %}
<div id="kelolaAdmin" class="container-fluid" style="margin-top: 1.5rem">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 poppins-regular mb-md-0 mb-sm-2 text-gray-800" data-aos="zoom-in-right" data-aos-delay="200"
            data-aos-duration="800">
            Tugas Departemen
        </h1>
        <h1 id="clock"
            class="h6 border border-1 rounded border-secondary-subtle p-1 px-2 poppins-regular mb-0 text-gray-800"
            data-aos="zoom-in-left" data-aos-delay="200" data-aos-duration="800"></h1>
    </div>

    <div class="container">
        <!-- ini untuk role jika admin /sub admin -->
        {% if data.role==1 %}

        <!--ini role departement mentor sub admin -->

        {% if data.departement != 'Superuser' and data.jobs=='Sub Admin' %}
        <!-- Button to trigger modal -->
        <div class="text-end mb-3">
            <button class="btn btn-primary {{ 'disabled' if data_user_all|length == 0 else '' }}" data-bs-toggle="modal"
                data-bs-target="#taskModal">
                <i class="fas fa-plus"></i> Tambahkan Tugas
            </button>
        </div>
        {% endif %}

        <!-- Task Table -->
        <div data-aos="zoom-in" data-aos-delay="400" data-aos-duration="800">
            <table id="taskTable" class="table table-striped display no-wrap table-winnicode w-100">
                <thead>
                    <tr>
                        <th>No</th>
                        {% for th in table_heading %}

                        {% if th == 'jobs' %}
                        <th>Pekerjaan</th>
                        {% else %}
                        <th>{{ th }}</th>
                        {% endif %}

                        {% endfor %}
                        {% if path1 not in ('Karyawan', 'Magang') and path1 %}
                        {% if data.jobs=='Sub Admin' and data.departement=='Mentor' %}
                        <th>Action</th>
                        {% endif %}
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic rows will be appended here -->
                    <!-- enumerate data_user_all -->
                    {% for index, tr in enumerate(data_user_all) %}

                    <tr class="align-middle" id="{{ tr['_id'] }}"><!--  inisiasi id  -->
                        <td class="poppins-regular" style='cursor:default'>{{ index+1 }}</td>

                        {% if not path1 %}
                        <td class="poppins-regular"><a class="text-decoration-none" href="/task?path1={{ tr['jobs'] }}"
                                style="cursor: pointer;">{{
                                tr.jobs
                                }}</a></td>

                        {% elif path1 in ('Karyawan','Magang') %}
                        <td class="poppins-regular">{{ tr.nama
                            }}</td>
                        <td class="poppins-regular">{{ tr.departement
                            }}</td>
                        <td class="poppins-regular">{{ tr.email
                            }}</td>

                        {% else %}
                        <!-- taskname -->
                        <td class="poppins-regular">
                            <input class="border-0 poppins-regular bg-transparent text-center" type="text" id="taskName"
                                style="outline: none;" value="{{ tr.taskName }}" {{ '' if (data.jobs=='Sub Admin' and
                                data.departement=='Mentor' ) else 'readonly' }}>
                        </td>
                        <!-- desc -->
                        <td class="poppins-regular">
                            <textarea class="border-0 poppins-regular bg-transparent text-center" style="outline: none;"
                                id="description_task" {{ '' if (data.jobs=='Sub Admin' and data.departement=='Mentor' )
                                else 'readonly' }}>{{ tr.description_task }}</textarea>
                        </td>
                        <!-- link input -->
                        <td class="poppins-regular">
                            <input class="border-0 poppins-regular bg-transparent text-center" type="text"
                                id="link_input" style="outline: none;" value="{{ tr.link_input }}" {{ '' if
                                (data.jobs=='Sub Admin' and data.departement=='Mentor' ) else 'readonly' }}>
                        </td>
                        <!-- deadline -->
                        <td class="poppins-regular">
                            <input class="border-0 poppins-regular bg-transparent" type="datetime-local" id="deadline"
                                style="outline: none;" value="{{ tr.deadline }}" {{ '' if (data.jobs=='Sub Admin' and
                                data.departement=='Mentor' ) else 'readonly' }}>
                        </td>
                        <!-- sattus tasl -->
                        <td class="poppins-regular">
                            <input class="border-0 poppins-regular bg-transparent text-center" style="outline:none"
                                type="text" id="status_task" style="outline: none;" value="{{ tr.status_task }}"
                                readonly>
                        </td>
                        <!-- accepted -->
                        <td class="poppins-regular">
                            <select class="form-control bg-transparent border border-0 shadow-none p-0 text-center"
                                name="accepted" id="accepted" {{ '' if (data.jobs=='Sub Admin' and
                                data.departement=='Mentor' ) else 'readonly' }} {% if tr.status_task !='Success' %}
                                disabled {% endif %}>

                                <option value="False" {% if tr['accepted']==False %} selected {% endif %}>False</option>

                                <option value="True" {% if tr['accepted']==True %} selected {% endif %}>True</option>
                            </select>
                        </td>
                        {% endif %}

                        {% if path1 not in ('Karyawan', 'Magang') and path1
                        %}
                        {% if data.jobs=='Sub Admin' and data.departement=='Mentor' %}
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-danger delete-btn">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        {% endif %}
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Task Modal add -->
        <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="taskForm">
                        <div class="modal-header bg-primary">
                            <h5 class="modal-title poppins-semibold text-white" id="taskModalLabel">Tambahkan Tugas Baru
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- csrf_token -->
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <!-- metode input -->
                            <input type="hidden" name="_method" value="add">
                            <!--  nama task -->
                            <div class="mb-3">
                                <label for="taskName" class="form-label">Nama Tugas<span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="taskName"
                                    placeholder="Masukkan nama tugas yang tersedia" required
                                    oninvalid="this.setCustomValidity('nama tugas wajib diisi')"
                                    oninput="this.setCustomValidity('')" />
                            </div>
                            <!-- deskripsi task -->
                            <div class="mb-3">
                                <label for="description_task" class="form-label">Deskripsi Tugas<span
                                        class="text-danger">*</span></label>
                                <textarea id="description_task" class="form-control" cols="30" rows="2"
                                    placeholder="Masukkan Deskripsi Tugas" required
                                    oninvalid="this.setCustomValidity('Deskripsi tugas wajib diisi')"
                                    oninput="this.setCustomValidity('')"></textarea>
                            </div>
                            <!-- link task -->
                            <div class="mb-3">
                                <label for="link_input" class="form-label">Masukkan Link (jika
                                    diperlukan)</label>
                                <input type="text" class="form-control" id="link_input"
                                    placeholder="Masukkan link yang tersedia (jika diperlukan)" />
                                <div id="linkHelpBlock" class="form-text">
                                    <strong>*</strong>note: link yang dimasukkan
                                    diawali dengan https://* atau http://*
                                </div>
                            </div>
                            <!-- deadline -->
                            <div class="mb-3">
                                <label for="deadline" class="form-label">Batas Waktu<span
                                        class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="deadline" required
                                    oninvalid="this.setCustomValidity('Batas Waktu wajib diisi')"
                                    oninput="this.setCustomValidity('')" />
                            </div>
                            <!-- send to -->
                            <div class="mb-3">
                                <label for="send_to_user" class="form-label">Kirim kepada<span
                                        class="text-danger">*</span></label>
                                <select class="form-select" id="send_to_user"
                                    aria-placeholder="Masukkan kirim kepada pekerja (bukan admin/subadmin)" required
                                    oninvalid="this.setCustomValidity('Wajib dipilih')"
                                    oninput="this.setCustomValidity('')">
                                    <option value disabled selected>--Pilih user--</option>
                                    {% for user in data_user_for_add %}
                                    <option value="{{ user.email }}">{{
                                        user.nama
                                        }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <!-- jobs -->
                            <div class="mb-3">
                                <label for="jobs" class="form-label">Pekerjaan<span class="text-danger">*</span></label>
                                <select class="form-select" id="jobs" disabled aria-placeholder="Pilih pekerjaannya"
                                    required oninvalid="this.setCustomValidity('Wajib dipilih')"
                                    oninput="this.setCustomValidity('')">
                                    <option value disabled selected>--pilih perkejaannya--</option>
                                </select>
                            </div>
                            <!-- departement -->
                            <div class="mb-3">
                                <label for="departement" class="form-label">Departemen<span
                                        class="text-danger">*</span></label>
                                <select class="form-select" id="departement" disabled
                                    aria-placeholder="Masukkan pilih departemennya" required
                                    oninvalid="this.setCustomValidity('Wajib dipilih')"
                                    oninput="this.setCustomValidity('')">
                                    <option value disabled selected>--pilih departemennya--</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="reset" class="btn btn-danger" data-bs-dismiss="modal"
                                aria-label="Close">Tutup</button>
                            <button type="submit" class="btn btn-primary">Kirim</button>
                        </div>
                </div>
                </form>
            </div>
        </div>

        <!-- task magang -->
        {% elif data.role!=1 %}
        <!-- Task Table user -->
        <div data-aos="zoom-in" data-aos-delay="400" data-aos-duration="800" class="table-responsive">
            <table id="taskTableUser" class="table display no-wrap table-winnicode w-100 align-middle">
                <thead>
                    <tr>
                        <th class="bg-warning poppins-semibold text-white">Ditunggu</th>
                        <th class="poppins-semibold bg-secondary text-white">Berjalan</th>
                        <th class="poppins-semibold bg-success text-white">Selesai</th>
                        <th class="poppins-semibold bg-primary text-white">Penolakan</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in data_user_all %}

                    <tr id="{{user['_id']}}">

                        <td id="Pending" class="sortable" {% if user.dataSort %} data-sortable="false" {% else %}
                            data-sortable="true" {% endif %}>
                            {% if user.status_task == 'Pending' %}
                            <div class="card text-start">

                                {% if user.link_input %}
                                <i class=" position-absolute top-0 end-0 fa-solid fa-up-right-from-square fa-sm lh-1 text-secondary mt-1 me-1"
                                    onclick="window.open('{{ user.link_input }}', '_blank')"
                                    style='cursor: pointer'></i>
                                {% endif %}
                                <div class="card-body">
                                    <h5 class="card-title poppins-medium">{{
                                        user.taskName }}</h5>
                                    <p class="card-text poppins-regular">{{
                                        user.description_task }}</p>
                                    <p
                                        class="deadline poppins-regular {% if user.dataSort %}text-danger{%else%}text-secondary{%endif%}">
                                        {{user.deadline}}</p>
                                </div>
                            </div>
                            {% endif %}
                        </td>
                        <td id="Progress" class="sortable" {% if user.dataSort %} data-sortable="false" {% else %}
                            data-sortable="true" {% endif %}>
                            {% if user.status_task == 'Progress' %}
                            <div class="card text-start mb-4">

                                {% if user.link_input %}
                                <i class="position-absolute top-0 end-0 fa-solid fa-up-right-from-square fa-sm lh-1 text-secondary mt-1 me-1"
                                    onclick="window.open('{{ user.link_input }}', '_blank')"
                                    style='cursor: pointer'></i>
                                {% endif %}
                                <div class="card-body">
                                    <h5 class="card-title poppins-medium">{{
                                        user.taskName }}</h5>
                                    <p class="card-text poppins-regular">{{
                                        user.description_task }}</p>
                                    <p
                                        class="deadline poppins-regular {% if user.dataSort %}text-danger{%else%}text-secondary{%endif%}">
                                        {{user.deadline}}</p>
                                </div>
                            </div>
                            {% endif %}

                        </td>
                        <td id="Success" class="sortable" {% if user.dataSort %} data-sortable="false" {% else %}
                            data-sortable="true" {% endif %}>
                            {% if user.status_task == 'Success' %}
                            <div class="card text-start mb-4">

                                {% if user.link_input %}
                                <i class=" position-absolute top-0 end-0 fa-solid fa-up-right-from-square fa-sm lh-1 text-secondary mt-1 me-1"
                                    onclick="window.open('{{ user.link_input }}', '_blank')"
                                    style='cursor: pointer'></i>
                                {% endif %}
                                <div class="card-body">
                                    <h5 class="card-title poppins-medium">{{
                                        user.taskName }}</h5>
                                    <p class="card-text poppins-regular">{{
                                        user.description_task }}</p>
                                    <p
                                        class="deadline poppins-regular {% if user.dataSort %}text-danger{%else%}text-secondary{%endif%}">
                                        {{user.deadline}}</p>
                                </div>
                            </div>
                            {% endif %}

                        </td>
                        <td id="active" class="text-center">

                            {% if user.accepted == True %}
                            <button class="btn btn-success text-white poppins-regular">Project Diterima</button>
                            {% else %}
                            <button class="btn btn-danger text-white poppins-regular">Project Ditolak</button>
                            {% endif %}

                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
    {% endblock %}
    <!-- custom js -->
    <!-- cdn js custom -->
    {% block cdn_custom_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <!-- datatables cdn js -->
    <script src="{{ url_for('static',filename='js/vfs_font.js') }}"></script>
    <script
        src="https://cdn.datatables.net/v/bs5/jq-3.7.0/jszip-3.10.1/dt-2.1.8/af-2.7.0/b-3.1.2/b-colvis-3.1.2/b-html5-3.1.2/b-print-3.1.2/cr-2.0.4/date-1.5.4/fc-5.0.3/fh-4.0.1/kt-2.12.1/r-3.0.3/rg-1.5.0/rr-1.5.0/sc-2.4.3/sb-1.8.1/sp-2.3.3/sl-2.1.0/sr-1.4.1/datatables.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    {% endblock %}
    <!-- block js custom -->
    {% block js_custom %}
    <!-- js custom -->
    <script src="{{ url_for('static', filename='js/index.js') }}"></script>

    <!-- for admin mentor -->
    {% if data.role==1%}

    <script>
        $(document).ready(function () {
            const options = [...Array(parseInt('{{ data_user_all[0]|length }}')).keys()];

            //membuat fonts default export
            pdfMake.fonts = {
                Times: {
                    normal: 'times-new-roman.ttf',
                    bold: 'times-new-roman-bold.ttf',
                    italics: 'times-new-roman-italic.ttf',
                    bolditalics: 'times-new-roman-bold-italic.ttf'
                }
            };

            /**
            * Customize Print DOCS
            * ==================
            *
            * @param {obj} win - document print
            * @example
            * // Contoh penggunaan
            * customizePrint(win)
            */
            customizePrint = (win) => {
                templateHeading = ` 
                <header class='d-flex flex-column justify-content-center align-items-center'>
                <h3 class="text-pink poppins-medium">Laporan Winnicode Garuda Terknologi</h3>
                <h3 class="text-pink poppins-medium">Table Tugas Karyawan</h3>
                </header>`

                //membuat border dan mealukan penambahan judul
                $(win.document.body).find('h1').remove()
                $(win.document.body).prepend(templateHeading)
                $(win.document.body).find('tr').children().addClass('text-center border border-dark border-1')

                // Menambahkan informasi tambahan di bawah tabel
                $(win.document.body).find('table').after(
                    '<footer class="d-flex flex-column justify-content-center align-items-end">' +
                    '<p class="poppins-light">Dicetak pada: ' + new Date().toLocaleString() + '</p>' +
                    '<p class="poppins-light">Dibuat oleh: <span class="poppins-semibold"><span class="text-pink">Absensi</span>Ku</span></p>' +
                    '</footer>'
                )
                //tambahkan background table 
                $(win.document.body).find('table tbody tr>*').css('background-color', 'transparent')
            }

            /** 
            * Customize PDF DOCS
            * ==================
            *
            * @param {obj} doc - document pdf
            * @example
            * // Contoh penggunaan
            * customizePDF(doc)
            */
            customizePDF = (doc) => {
                // Kustomisasi PDF
                doc.defaultStyle = {
                    font: 'Times', // Gunakan font Times New Roman
                    fontSize: 10,  // Ukuran font default
                };
                // 1. Menambahkan Header
                doc.content.splice(0, 0, {
                    alignment: 'center',
                    text: [
                        { text: 'Laporan Winnicode Garuda Teknologi\n', fontSize: 18, bold: true, color: 'pink' },
                        { text: 'Table Tugas Karyawan\n\n', fontSize: 15, bold: true, color: 'pink' }
                    ]
                });

                // 2. Menambahkan Footer dengan Tanggal dan Nama Pembuat
                doc.content.push({
                    alignment: 'center',
                    margin: [0, 40, 0, 0],
                    text: [
                        { text: `Dicetak pada: ${new Date().toLocaleString()}\n`, fontSize: 10, font: 'Times', color: 'black' },
                        {
                            text: 'Dibuat oleh: ',
                            fontSize: 10,
                            font: 'Times',
                            color: 'black'
                        },
                        {
                            text: 'Absensi',
                            fontSize: 10,
                            bold: true,
                            font: 'Times',
                            color: 'pink'
                        },
                        {
                            text: 'Ku',
                            fontSize: 10,
                            bold: true,
                            font: 'Times',
                            color: 'black'
                        }
                    ]
                });

                // 3. Mengatur Gaya Font dan Ukuran Teks di Tabel
                doc.styles.tableHeader = {
                    fontSize: 12,
                    bold: true,
                    color: 'black',
                    fillColor: '#ff66c4',
                    alignment: 'center'  // Perataan tengah untuk teks di header
                };
                doc.content.splice(1, 1)

                //mengatur data table menjadi tengah
                doc.content[1].table.body.forEach(function (row, rowIndex) {
                    if (rowIndex !== 0) {
                        row.forEach(function (cell, cellIndex) {
                            if (cell.text) {
                                cell.alignment = 'center'
                            }
                        })
                    }
                });

                // Mengatur margin untuk membuat tabel menjadi rata tengah
                doc.content[1].margin = [50, 0, 100, 0]; // margin kiri, atas, kanan, bawah
            }

            //initalize datatables
            $('#taskTable').DataTable({
                dom: (('{{ data.jobs }}' == 'Admin') && ('{{ data.departement }}' == 'Mentor')) ? '<"mb-4"B><"d-flex flex-column flex-md-row gap-3 justify-content-center justify-content-md-between mb-3"<l><f>>t<"mt-3" <i><p>>' : '<"d-flex flex-column flex-md-row gap-3 justify-content-center justify-content-md-between mb-3"<l><f>>t<"mt-3" <i><p>>',
                language: {
                    url: "{{ url_for('static',filename='/data/id.json') }}"
                },
                buttons: [
                    {
                        extend: "copy",
                        text: '<i class="fas fa-copy"></i> Copy', // Tambahkan ikon FontAwesome
                        className: "btn btn-primary",
                        exportOptions: {
                            columns: options, // Indeks kolom yang ingin diexport
                            format: {
                                body: function (data, row, column, node) {
                                    $node = $(node)

                                    // Cek dan ambil dari input jika ada dan memiliki value
                                    if ($node.find('input').length > 0) {
                                        let val = $node.find('input').val();
                                        if (val) return val;
                                    }

                                    // Cek textarea
                                    if ($node.find('textarea').length > 0) {
                                        let val = $node.find('textarea').val();
                                        if (val) return val;
                                    }

                                    // Cek select
                                    if ($node.find('select').length > 0) {
                                        let val = $node.find('select option:selected').text();
                                        if (val) return val;
                                    }

                                    // Kalau bukan input, textarea, atau select, ambil teks default
                                    return $node.text().trim();
                                }
                            }
                        },
                    },
                    {
                        extend: "csv",
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        className: "btn btn-warning",
                        exportOptions: {
                            columns: options, // Indeks kolom yang ingin diexport
                            format: {
                                body: function (data, row, column, node) {
                                    $node = $(node)

                                    // Cek dan ambil dari input jika ada dan memiliki value
                                    if ($node.find('input').length > 0) {
                                        let val = $node.find('input').val();
                                        if (val) return val;
                                    }

                                    // Cek textarea
                                    if ($node.find('textarea').length > 0) {
                                        let val = $node.find('textarea').val();
                                        if (val) return val;
                                    }

                                    // Cek select
                                    if ($node.find('select').length > 0) {
                                        let val = $node.find('select option:selected').text();
                                        if (val) return val;
                                    }

                                    // Kalau bukan input, textarea, atau select, ambil teks default
                                    return $node.text().trim();
                                }
                            }
                        },
                    },
                    {
                        extend: "excel",
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: "btn btn-success",
                        exportOptions: {
                            columns: options, // Indeks kolom yang ingin diexport
                            format: {
                                body: function (data, row, column, node) {
                                    $node = $(node)

                                    // Cek dan ambil dari input jika ada dan memiliki value
                                    if ($node.find('input').length > 0) {
                                        let val = $node.find('input').val();
                                        if (val) return val;
                                    }

                                    // Cek textarea
                                    if ($node.find('textarea').length > 0) {
                                        let val = $node.find('textarea').val();
                                        if (val) return val;
                                    }

                                    // Cek select
                                    if ($node.find('select').length > 0) {
                                        let val = $node.find('select option:selected').text();
                                        if (val) return val;
                                    }

                                    // Kalau bukan input, textarea, atau select, ambil teks default
                                    return $node.text().trim();
                                }
                            }
                        },
                    },
                    {
                        extend: "pdf",
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        className: "btn btn-danger",
                        exportOptions: {
                            columns: options,
                            format: {
                                body: function (data, row, column, node) {
                                    $node = $(node)

                                    // Cek dan ambil dari input jika ada dan memiliki value
                                    if ($node.find('input').length > 0) {
                                        let val = $node.find('input').val();
                                        if (val) return val;
                                    }

                                    // Cek textarea
                                    if ($node.find('textarea').length > 0) {
                                        let val = $node.find('textarea').val();
                                        if (val) return val;
                                    }

                                    // Cek select
                                    if ($node.find('select').length > 0) {
                                        let val = $node.find('select option:selected').text();
                                        if (val) return val;
                                    }

                                    // Kalau bukan input, textarea, atau select, ambil teks default
                                    return $node.text().trim();
                                }
                            }
                        },
                        customize: function (doc) {
                            customizePDF(doc)
                        }
                    },
                    {
                        extend: "print",
                        text: '<i class="fas fa-print"></i> Print',
                        className: "btn btn-info",
                        exportOptions: {
                            columns: options, // Indeks kolom yang ingin diexport
                            format: {
                                body: function (data, row, column, node) {
                                    $node = $(node)

                                    // Cek dan ambil dari input jika ada dan memiliki value
                                    if ($node.find('input').length > 0) {
                                        let val = $node.find('input').val();
                                        if (val) return val;
                                    }

                                    // Cek textarea
                                    if ($node.find('textarea').length > 0) {
                                        let val = $node.find('textarea').val();
                                        if (val) return val;
                                    }

                                    // Cek select
                                    if ($node.find('select').length > 0) {
                                        let val = $node.find('select option:selected').text();
                                        if (val) return val;
                                    }

                                    // Kalau bukan input, textarea, atau select, ambil teks default
                                    return $node.text().trim();
                                }
                            }
                        },
                        customize: function (win) {
                            customizePrint(win)

                            // Tambahkan alert untuk pengingat
                            alert('Pastikan untuk mencentang opsi "Background graphics" di pengaturan cetak untuk menampilkan warna yang sesuai.');
                        }
                    },
                ],
                scrollX: true,
                keys: true,
                scrollCollapse: true, // Allow the table to reduce in height if there are fewer rows
                fixedHeader: true,
                lengthMenu: [5, 10, 25, 50, 75, { label: "All", value: -1 }],
                pageLength: 10,
            });

            if ('{{ data.departement | title }}' == 'Mentor' && '{{ data.jobs | title }}' == 'Sub Admin') {
                //for link input
                document.getElementById("link_input").addEventListener("input", function () {
                    const input = this.value.trim(); // Ambil nilai input
                    const hasValidPrefix = input.startsWith("https://") || input.startsWith("http://");

                    if (input !== "" && !hasValidPrefix) {
                        // Jika input tidak kosong dan tidak valid, tambahkan kelas 'border-danger'
                        this.classList.add("border-danger");
                    } else {
                        // Jika input kosong atau valid, hapus kelas 'border-danger'
                        this.classList.remove("border-danger");
                    }
                });

                //delete task
                $(document).on("click", ".delete-btn", function () {
                    const trId = $(this).closest("tr").attr("id");

                    //custom swal
                    const swalWithBootstrapButtons = Swal.mixin({
                        customClass: {
                            confirmButton: "btn btn-primary ms-1",
                            cancelButton: "btn btn-danger me-1",
                            title: 'text-danger',  // Judul modal berwarna merah
                            icon: 'text-danger',   // Ikon warning berwarna merah
                        },
                        buttonsStyling: false
                    });

                    //jalankan swall fire dengan customize tadi
                    swalWithBootstrapButtons.fire({
                        icon: "warning",
                        title: `Tugas id : ${trId}`,
                        text: "Apakah kamu yakin ingin menghapus data ini?",
                        showCancelButton: true,
                        confirmButtonText: "Ya, Hapus!",
                        cancelButtonText: "Jangan, Tidak jadi!",
                        reverseButtons: true
                    }).then((result) => {
                        //jika dikonfirmasi
                        if (result.isConfirmed) {

                            //nyalanakan loading
                            $("section#menu").fadeOut(200, async function () {
                                $("section#loading").fadeIn(500, function () {
                                    //kirim data ke server melalui ajax
                                    $.ajax({
                                        type: "POST",
                                        url: `/task/delete`,
                                        data: JSON.stringify({ id: trId }),
                                        headers: {
                                            "X-CSRF-Token": '{{ csrf_token() }}',
                                            "Content-Type": "application/json"
                                        },
                                        dataType: "json",
                                        //success
                                        success: function (response, status, xhr) {
                                            console.log(response, status, xhr);
                                            $('section#loading').fadeOut(500, function () {

                                                if (xhr.status == 200 && response.redirect) {
                                                    swalWithBootstrapButtons.fire({
                                                        title: "Hapus!",
                                                        text: "Tugas mu telah dihapus",
                                                        icon: "success",
                                                        timer: 3000,
                                                        willClose: function () {
                                                            window.location.reload(), xhr.status
                                                        }
                                                    }), xhr.status;
                                                }
                                            })
                                        },
                                        //error
                                        error: function (xhr, status, error) {
                                            console.error(xhr, ',', status, ',', error);

                                            $('section#loading').fadeOut(500, function () {
                                                if (xhr.responseJSON.redirect) {
                                                    window.location.replace(xhr.responseJSON.redirect), 500
                                                } else {
                                                    window.location.replace("/task/msg=jaringan Error"), 500
                                                }
                                            });
                                        }
                                    })
                                });
                            });
                            //jika dicanel
                        } else if (
                            /* Read more about handling dismissals below */
                            result.dismiss === Swal.DismissReason.cancel
                        ) {
                            return
                        }
                    })
                })
            }

            // Add Task Form Submit
            $("#taskModal #taskForm").on("submit", function (e) {
                e.preventDefault();
                $('#taskModal').modal('hide')
                const csrf_token = $(this).find("input[name=csrf_token]").val().trim();
                const method = $(this).find("input[name=_method]").val().trim();
                const taskName = $(this).find("#taskName").val().trim();
                const description_task = $(this).find("#description_task").val().trim();
                const link_input = $(this).find("#link_input").val().trim();
                const deadline = $(this).find("#deadline").val().trim();
                const send_to_user = $(this).find("#send_to_user").val().trim();
                const jobs = $(this).find("#jobs").val().trim();
                const departement = $(this).find("#departement").val().trim();

                if ($(this).find('#link_input').hasClass('border-danger')) {
                    window.location.replace("/task?msg=Link harus diawali dengan http:// atau https://");
                    return
                }

                $("section#menu").fadeOut(200, async function () {
                    $("section#loading").fadeIn(500, function () {
                        if (csrf_token === "" || method === "" || taskName === "" || description_task === "" || deadline === "" || send_to_user === "" || jobs === "" || departement === "") {
                            console.error('formnya Kosong gan !!!')
                            window.location.replace("/task?msg=Form dengan tanda <span class='text-danger fw-bold'>*</span> tidak boleh kosong");
                        }

                        //jadikan obejct
                        const data = {
                            taskName: taskName,
                            description_task: description_task,
                            link_input: link_input,
                            deadline: deadline,
                            send_to_user: send_to_user,
                            jobs: jobs,
                            departement: departement,
                        };

                        //lakukan ajax
                        $.ajax({
                            type: "POST",
                            url: `/task/${method}`,
                            data: JSON.stringify(data),
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRF-Token": csrf_token,
                            },
                            dataType: "json",
                            success: function (response, status, xhr) {
                                //saat success
                                console.log(response, status, xhr)
                                $('section#loading').fadeOut(500, function () {
                                    if (status === 'success' && xhr.status === 200) {
                                        window.location.replace(response.redirect), xhr.status
                                    }
                                });
                            },
                            error: function (xhr, status, error) {
                                // Tindakan jika gagal
                                console.log(xhr, status, error);
                                $('section#loading').fadeOut(500, function () {
                                    if (xhr.responseJSON.redirect) {
                                        window.location.replace(xhr.responseJSON.redirect), 500
                                    } else {
                                        window.location.replace("/task/msg=jaringan Error"), 500
                                    }
                                });
                            }
                        })
                    })
                });
            });

            //global varnya
            const data_user_all_json = JSON.parse('{{ data_user_for_add|tojson }}'); // dapatkan data json dari server

            //saat select send to user di change
            $('#send_to_user').on('change', function () {
                var selectedValue = $(this).val(); //ambil value select

                //hapus disable
                $('#jobs').attr('disabled', false);

                // Kosongkan opsi di dropdown #jobs
                $('#jobs').empty();

                // Tambahkan opsi default kembali
                $('#jobs').append('<option value disabled selected>--select send to user--</option>');

                //hapus disable
                $('#departement').attr('disabled', true);

                // Kosongkan opsi di dropdown #departement
                $('#departement').empty();

                // Tambahkan opsi default kembali
                $('#departement').append('<option value disabled selected>--select send to user--</option>');

                // lakukan perurangan data_user_all dan samakan dengan selectend value
                for (const user of data_user_all_json) {
                    if (user.email == selectedValue) {
                        $('#jobs').append(`<option value="${user.jobs}">${user.jobs}</option>`) //ta,bah option selanjutnya
                    }
                }
            });

            //saat select jobs di change
            $('#jobs').on('change', function () {
                var selectedValueUser = $('#send_to_user').val(); //ambil value select send to user
                var selectedValue = $(this).val(); //ambil value select jobs
                //hapus disable
                $('#departement').attr('disabled', false);
                // Kosongkan opsi di dropdown #departement
                $('#departement').empty();
                // Tambahkan opsi default kembali
                $('#departement').append('<option value disabled selected>--select send to user--</option>');
                // lakukan perurangan data_user_all dan samakan dengan selectend value
                for (const user of data_user_all_json) {
                    if (user.email == selectedValueUser && user.jobs == selectedValue) {
                        $('#departement').append(`<option value="${user.departement}">${user.departement}</option>`)
                    }
                }
            });
        });
        //end

        //customize theme 
        let color = null
        if ($('html').attr('data-bs-theme') === 'dark') {
            console.log('jalan1')
            color = 'text-light'
            $('tr td a').addClass(color).removeClass('text-dark')
        } else {
            console.log('jalann1')
            color = 'text-dark'
            $('tr td a').addClass(color).removeClass('text-light')
        }


        $("#darkModeSwitch #hide-checkbox").on("click", function () {
            //jika data lama adalah dark maka ubah ke white
            if ($('html').attr('data-bs-theme') === 'dark') {
                console.log('jalan')
                color = 'text-dark'
                $('tr td a').addClass(color).removeClass('text-white')
                //jika data lama adalah nondark maka ubah ke dark
            } else {
                console.log('jalann')
                color = 'text-white'
                $('tr td a').addClass(color).removeClass('text-dark')
            }
        })

        //function handle link td a href saat mouse over dan mouse out
        $(document).on('mouseover', 'tr td a', function () {
            $(this).removeClass(color)
            $(this).removeClass('text-decoration-none')

        });
        //hadle mouse out
        $(document).on('mouseout', 'tr td a', function () {
            $(this).addClass(color)
            $(this).addClass('text-decoration-none')
        });

        //cek path1 sama dengan karyawan dan magang untuk dispatch
        if (['Karyawan', 'Magang'].includes('{{ path1 }}')) {
            $('#taskTable').on('click', 'tr', function (e) {
                const tr = e.currentTarget.id.toString()
                window.location.href = `/task?path1=${tr}`
            })
        };
    </script>

    {% if path1 and path1 not in ['karyawan', 'Magang']%}
    <script>
        const userDepartment = '{{ data.departement | title }}';
        const userJob = '{{ data.jobs | title }}';

        if (userDepartment == 'Mentor' && userJob == 'Sub Admin') {
            // edit input
            $('#taskTable tbody').on('click', 'td input, td select, td textarea', function (e) {

                //inisiasi
                const cell = $(this)
                const inputId = cell.attr('id').trim();
                const oldValue = cell.val();
                const rowId = cell.closest('tr').attr('id').trim();

                // Event ketika selesai mengetik
                cell.off('blur').on('blur', function () {
                    //value baru
                    const newValue = $(this).val().trim();

                    if (!newValue) {
                        if (inputId != 'link_input') {
                            console.error('Value tidak boleh kosong');
                            return;

                        }
                    }

                    //jika value baru sama dengan value lama dan bukan dari accepted
                    if (newValue === oldValue && inputId != 'accepted') {
                        console.error('Value tidak berubah');
                        return;
                    }

                    if (inputId == 'link_input') {
                        if (!newValue.startsWith('http://') && !newValue.startsWith('https://')) {
                            Swal.fire({
                                icon: "error",
                                title: "OOPS!",
                                html: `Link harus dimulai dengan http:// atau https://`,
                                timer: 3000,
                                willClose: () => {
                                    return
                                },
                            });
                            return
                        }
                    }

                    cell.prop('disabled', true); // Disable input temporarily
                    // Kirim data ke server
                    $.ajax({
                        url: '/task/edit', // Endpoint backend
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            rowId_receive: rowId,
                            inputId_receive: inputId,
                            newValue_receive: newValue,
                        }),
                        headers: {
                            'Content-Type': 'Application/json',
                            'X-CSRF-Token': '{{ csrf_token() }}'
                        },
                        success: function (response, status, xhr) {
                            console.log(response, status, xhr)
                            if (response.redirect && xhr.status == 200) {
                                const url = new URL(response.redirect, window.location.origin);
                                const msg = url.searchParams.get('msg');
                                Swal.fire({
                                    icon: "success",
                                    title: "Sukses!",
                                    html: `${msg}`,
                                    timer: 3000,
                                    willClose: () => {
                                        console.log('Update Data berhasil'), xhr.status;
                                    },
                                });
                            }

                        },
                        error: function (xhr, status, error) {
                            console.log(xhr, status, error);
                            if (xhr.responseJSON) {
                                const url = new URL(xhr.responseJSON.redirect, window.location.origin);
                                console.log(url)
                                const msg = url.searchParams.get('msg');
                                if (xhr.responseJSON.redirect && xhr.status == 500 && url.pathname !== '/sign-in/') {
                                    Swal.fire({
                                        icon: "error",
                                        title: "OOPS!",
                                        html: `${msg}`,
                                        timer: 3000,
                                        willClose: () => {
                                            console.log('Update data gagal'), 500;
                                        },
                                    });
                                } else if (xhr.responseJSON.redirect && xhr.status == 500 && url.pathname === '/sign-in/') {
                                    window.location.replace('/task')
                                }
                            }
                        },
                        complete: function () {
                            cell.prop('disabled', false); // Re-enable input
                        },
                    });

                });
            });
        }
    </script>
    {% endif %}
    {% endif %}

    <!-- for user  -->
    {% if data.role!=1 %}
    <script>
        $('#taskTableUser').DataTable({
            dom: 't'
        })
        const pendingContainer = document.querySelectorAll('#Pending');
        const progressContainer = document.querySelectorAll('#Progress');
        const successContainer = document.querySelectorAll('#Success');

        // Make columns sortable
        const sortableOptions = {
            group: 'shared', // Allow dragging between groups
            animation: 150,
            multiDrag: true, // Enable multi-dragging
            direction: 'horizontal', // Batasi drag hanya horizontal
            dragClass: 'dragging',
            onMove: function (evt) {
                // Validasi apakah row sortable berdasarkan atribut data-sortable
                const targetRow = evt.related;
                return targetRow.getAttribute('data-sortable') === 'true';
            },
            onEnd: function (evt) {

                if (!evt.item.querySelector('p.deadline') || evt.item.querySelector('p.deadline').classList.contains('text-danger') || !evt.target || evt.target.getAttribute('data-sortable') === 'false') {
                    return;
                }
                //ambil deadline
                const deadlineText = evt.item.querySelector('p.deadline').textContent.trim()
                //buat objek waktu
                const deadlineMoment = moment.tz(deadlineText, "YYYY-MM-DD HH:mm:ss", 'Asia/Jakarta');
                // Ambil waktu sekarang dengan zona waktu Asia/Jakarta
                const nowMoment = moment.tz("Asia/Jakarta");
                //saat setelah deadline
                if (nowMoment.isAfter(deadlineMoment)) {
                    console.log('Deadline sudah lewat')
                    Swal.fire({
                        icon: "error",
                        title: "Task Timeout!",
                        html: `Deadline sudah lewat anda tidak boleh melakukan perubahan`,
                        timer: 3000,
                        willClose: () => {
                            return
                        },
                    });
                    return;
                }
                // Ambil elemen <tr>  id yang merupakan parent dari item yang sedang dipindahkan
                const parentTrId = evt.item.closest('tr').id;
                //ambil column id berubah
                const tdId = evt.to.id;

                $("section#menu").fadeOut(200, async function () {
                    $("section#loading").fadeIn(500, function () {
                        $.ajax({
                            type: 'POST',
                            url: '/task/user/edit',
                            data: JSON.stringify({
                                parentTrId_receive: parentTrId,
                                tdId_receive: tdId
                            }),
                            headers: {
                                'Content-Type': 'Application/json',
                                'X-CSRFToken': '{{ csrf_token() }}'
                            },
                            timeout: 10000,
                            success: function (response, status, xhr) {
                                console.log(response, status, xhr)
                                if (response.redirect && xhr.status == 200) {
                                    window.location.replace(response.redirect), xhr.status
                                }
                            },
                            error: function (xhr, status, error) {
                                console.log(xhr, status, error)
                                if (xhr.responseJSON.redirect && xhr.status == 500) {
                                    window.location.replace(xhr.responseJSON.redirect)
                                }
                                else {
                                    Swal.fire({
                                        icon: "error",
                                        title: "OOPS!",
                                        html: `${error}`,
                                        timer: 3000,
                                        willClose: () => {
                                            console.log('Data updated Failedly'), xhr.status;
                                        },
                                    });
                                }
                            }
                        });
                    });
                });

            }
        };

        //ortable khusus pending
        pendingContainer.forEach((el) => {
            const sortablePending = new Sortable(el, sortableOptions);
        })
        //sortable khusus progress
        progressContainer.forEach((el) => {
            const sortableProgress = new Sortable(el, sortableOptions);
        })
        //sortable khusus success
        successContainer.forEach((el) => {
            const sortableSuccess = new Sortable(el, {
                group: {
                    name: 'shared',
                    pull: false,
                    put: true
                },
                animation: 150,
                dragClass: 'disabled-drag'
            });
        })
    </script>
    {% endif %}

    {% endblock js_custom %}

    <!-- message js -->
    {% block message %} {% if (result and msg) %}
    <script>
        Swal.fire({
            icon: "success",
            title: "Sukses!",
            html: "{{ msg }}",
            timer: 3000,
            willClose: () => {
                window.location.replace("/task");
            },
        });
    </script>
    {% elif msg %}
    <script>
        Swal.fire({
            icon: "error",
            title: "OOPS!",
            html: "{{ msg }}",
            timer: 3000,
            willClose: () => {
                window.location.replace("/task");
            },
        });
    </script>
    {% endif %} {% endblock %}